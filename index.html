<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAAD | Diagnostic IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --primary-dark: #1d4ed8; --bg-main: #f9f9fb; --sky-blue: #60a5fa; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        #preloader { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, var(--primary) 0%, var(--sky-blue) 60%, var(--bg-main) 100%); transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1); }
        .preloader-active { transform: translateY(-100%); }
        .loader-logo-base { font-size: 6rem; font-weight: 900; color: white; font-style: italic; position: relative; text-transform: uppercase; }
        .loader-logo-fill { position: absolute; top: 0; left: 0; color: var(--primary-dark); width: 0%; overflow: hidden; white-space: nowrap; transition: width 1s ease-in-out; }
        #ai-chat-modal { position: fixed; bottom: 2rem; right: 2rem; width: 360px; background: white; border-radius: 28px; box-shadow: 0 30px 70px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .chat-messages { height: 350px; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: #fafafa; }
        .msg { padding: 0.8rem 1.2rem; border-radius: 18px; font-size: 13px; line-height: 1.5; }
        .msg-user { align-self: flex-end; background: #2563eb; color: white; }
        .msg-ai { align-self: flex-start; background: white; border: 1px solid #eee; }
        .msg-error { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; align-self: center; width: 90%; font-size: 11px; }
    </style>
</head>
<body>
    <div id="preloader"><div class="loader-content"><div class="loader-logo-base">JAAD.<div class="loader-logo-fill" id="loader-fill">JAAD.</div></div></div></div>

    <div id="ai-chat-modal">
        <div class="bg-blue-600 p-5 text-white flex justify-between items-center font-black">
            <span>JAAD AI - DIAGNOSTIC</span>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="msg msg-ai text-xs">Testez le chat pour voir l'erreur exacte.</div>
        </div>
        <div class="p-4 flex gap-2 border-t">
            <input type="text" id="chat-input" class="flex-1 outline-none text-xs" placeholder="Tapez ici..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
            <button onclick="sendChatMessage()" class="bg-blue-600 text-white p-3 rounded-full"><i data-lucide="send" class="w-4 h-4"></i></button>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const fill = document.getElementById('loader-fill');
            setTimeout(() => { fill.style.width = '100%'; }, 300);
            setTimeout(() => { document.getElementById('preloader').classList.add('preloader-active'); }, 1800);
            lucide.createIcons();
        });

        async function callAi(text) {
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    return { error: true, message: `Erreur ${res.status}: ${data.error}`, details: data.details || data.debug };
                }
                return { error: false, text: data.text };
            } catch (e) {
                return { error: true, message: "Impossible de contacter /api/chat. Le dossier api est-il bien sur GitHub ?" };
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-messages');
            if(!input.value.trim()) return;
            const msg = input.value;
            box.innerHTML += `<div class="msg msg-user">${msg}</div>`;
            input.value = '';
            
            const response = await callAi(msg);
            
            if (response.error) {
                box.innerHTML += `<div class="msg msg-error"><b>${response.message}</b><br>${JSON.stringify(response.details || '')}</div>`;
            } else {
                box.innerHTML += `<div class="msg msg-ai">${response.text}</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
